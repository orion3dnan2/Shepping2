{% extends "base.html" %}

{% block title %}الإعدادات{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <h1 class="page-title">
                    <i class="fas fa-cog me-2"></i>
                    الإعدادات
                </h1>
                <p class="page-description">إدارة جميع إعدادات النظام من مكان واحد</p>
            </div>

            <!-- Settings Navigation Tabs -->
            <div class="settings-tabs mb-4">
                <nav class="nav nav-pills nav-fill" id="settingsTab" role="tablist">
                    <button class="nav-link active" id="types-tab" data-bs-toggle="pill" data-bs-target="#types" type="button" role="tab" aria-controls="types" aria-selected="true">
                        <i class="fas fa-tags me-2"></i>
                        إدارة الأنواع
                    </button>
                    <button class="nav-link" id="pricing-tab" data-bs-toggle="pill" data-bs-target="#pricing" type="button" role="tab" aria-controls="pricing" aria-selected="false">
                        <i class="fas fa-dollar-sign me-2"></i>
                        الأسعار
                    </button>
                    <button class="nav-link" id="users-tab" data-bs-toggle="pill" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="false">
                        <i class="fas fa-users me-2"></i>
                        إدارة المستخدمين
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="settingsTabContent">
                <!-- Manage Types Tab -->
                <div class="tab-pane fade show active" id="types" role="tabpanel" aria-labelledby="types-tab">
                    <div class="settings-section">
                        <div class="section-header">
                            <h3>إدارة أنواع الشحنات والوثائق</h3>
                            <p class="text-muted">إضافة وتعديل وحذف أنواع الشحنات والوثائق المتاحة في النظام</p>
                        </div>

                        <!-- Shipment Types Section -->
                        <div class="types-container mb-5">
                            <div class="mb-3">
                                <h4 class="section-title">أنواع الشحنات</h4>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover types-table">
                                    <thead class="table-header">
                                        <tr>
                                            <th>الاسم بالعربية</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <span class="fw-medium">عامة</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">نشط</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <span class="fw-medium">مستندات</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-success">نشط</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Document Types Section -->
                        <div class="types-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="section-title">نوع المستند</h4>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDocumentTypeModal">
                                    <i class="fas fa-plus me-2"></i>
                                    إضافة نوع وثيقة
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover types-table">
                                    <thead class="table-header">
                                        <tr>
                                            <th>الاسم بالعربية</th>
                                            <th>السعر (د.ك)</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for document_type in document_types %}
                                        <tr>
                                            <td>
                                                <span class="fw-medium">{{ document_type.name_ar }}</span>
                                            </td>
                                            <td>
                                                <span class="price-text">{{ "%.3f"|format(document_type.price) }}</span>
                                            </td>
                                            <td>
                                                {% if document_type.is_active %}
                                                    <span class="badge bg-success">نشط</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">غير نشط</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-2" 
                                                        onclick="editDocumentType({{ document_type.id }}, '{{ document_type.name_ar }}', '{{ document_type.name_en }}', {{ document_type.price }}, {{ document_type.is_active|lower }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form method="post" action="{{ url_for('delete_document_type', type_id=document_type.id) }}" style="display: inline;" 
                                                      onsubmit="return confirm('هل أنت متأكد من حذف هذا النوع؟')">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>


                    </div>
                </div>

                <!-- Pricing Management Tab -->
                <div class="tab-pane fade" id="pricing" role="tabpanel" aria-labelledby="pricing-tab">
                    <div class="settings-section">
                        <div class="section-header">
                            <h3>الأسعار</h3>
                            <p class="text-muted" style="font-size: 0.9rem; margin-top: 10px;">تحديث أسعار جميع أنواع الشحنات والوثائق بسهولة</p>
                        </div>

                        <!-- Pricing Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-icon bg-primary">
                                        <i class="fas fa-box"></i>
                                    </div>
                                    <div class="stats-content">
                                        <h3>{{ shipment_types|length }}</h3>
                                        <p>أنواع الشحنات</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-icon bg-success">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="stats-content">
                                        <h3>{{ document_types|length }}</h3>
                                        <p>أنواع الوثائق</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-icon bg-info">
                                        <i class="fas fa-dollar-sign"></i>
                                    </div>
                                    <div class="stats-content">
                                        <h3>{{ "%.2f"|format(total_pricing) }}</h3>
                                        <p>إجمالي الأسعار (د.ك)</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Price per KG Setting -->
                        <div class="pricing-section mb-5">
                            <h4 class="section-title mb-3" style="color: #000000; font-weight: 700;">سعر الكيلو للشحنات</h4>
                            <div class="price-per-kg-container">
                                <form method="post" action="{{ url_for('update_price_per_kg') }}" class="row g-3 align-items-center">
                                    <div class="col-md-2">
                                        <label class="form-label kg-price-label">سعر الكيلو</label>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <input type="number" step="0.001" class="form-control price-per-kg-input-compact" name="price_per_kg" 
                                                   id="pricePerKgInput" value="{{ price_per_kg or '0.000' }}" min="0" required placeholder="أدخل السعر"
                                                   oninput="updatePricePerKgDisplay(this.value)">
                                            <span class="input-group-text">د.ك</span>
                                        </div>
                                        <div class="form-text text-muted">سيتم استخدام هذا السعر لحساب التكلفة الإجمالية للشحنات</div>
                                        <!-- Live Price Display -->
                                        <div class="mt-3 p-3 rounded" style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border: 1px solid #c3e6cb;">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <span class="text-success fw-bold">السعر الحالي:</span>
                                                <span class="text-success fw-bold fs-5" id="currentPriceDisplay">{{ "%.3f"|format(price_per_kg|float if price_per_kg else 0) }} د.ك</span>
                                            </div>
                                            <small class="text-muted d-block mt-1">يتم التحديث فورياً مع تغيير القيمة</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="submit" class="btn btn-primary btn-save-kg-price">
                                            <i class="fas fa-save me-2"></i>
                                            حفظ السعر
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Additional Pricing Settings -->
                        <div class="pricing-section">
                            <h4 class="section-title mb-3" style="color: #000000; font-weight: 700;">أسعار إضافية</h4>
                            
                            <!-- Packaging Price -->
                            <div class="price-per-kg-container mb-4">
                                <form method="post" action="{{ url_for('update_packaging_price') }}" class="row g-3 align-items-center">
                                    <div class="col-md-2">
                                        <label class="form-label kg-price-label">سعر التغليف</label>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="input-group">
                                            <input type="number" step="0.001" class="form-control price-per-kg-input-compact" name="packaging_price" 
                                                   id="packagingPriceInput" value="{{ packaging_price or '0.000' }}" min="0" required placeholder="أدخل السعر"
                                                   oninput="updatePackagingPriceDisplay(this.value)">
                                            <span class="input-group-text">د.ك</span>
                                        </div>
                                        <div class="form-text text-muted">سيتم إضافة هذا السعر عند اختيار التغليف</div>
                                        <!-- Live Packaging Price Display -->
                                        <div class="mt-3 p-3 rounded" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border: 1px solid #ffc107;">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <span class="text-warning fw-bold">سعر التغليف الحالي:</span>
                                                <span class="text-warning fw-bold fs-5" id="currentPackagingPriceDisplay">{{ "%.3f"|format(packaging_price|float if packaging_price else 0) }} د.ك</span>
                                            </div>
                                            <small class="text-muted d-block mt-1">يتم التحديث فورياً مع تغيير القيمة</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="submit" class="btn btn-primary btn-save-kg-price">
                                            <i class="fas fa-save me-2"></i>
                                            حفظ السعر
                                        </button>
                                    </div>
                                </form>
                            </div>


                        </div>

                        <!-- Document Types Section -->
                        <div class="pricing-section">
                            <h4 class="section-title mb-3">أنواع الإجراءات للوثائق</h4>
                            <div class="table-responsive">
                                <table class="table table-hover pricing-table">
                                    <thead class="table-header">
                                        <tr>
                                            <th>نوع الإجراء</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for document_type in document_types %}
                                        <tr>
                                            <td>
                                                <span class="fw-medium">{{ document_type.name_ar }}</span>
                                            </td>
                                            <td>
                                                {% if document_type.is_active %}
                                                    <span class="badge bg-success">نشط</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">غير نشط</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
                    <div class="settings-section">
                        <div class="section-header">
                            <h3>إدارة المستخدمين والصلاحيات</h3>
                            <p class="text-muted">إضافة وتعديل وحذف المستخدمين وإدارة صلاحياتهم في النظام</p>
                        </div>

                        <!-- Add User Button -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="section-title">قائمة المستخدمين</h4>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="fas fa-user-plus me-2"></i>
                                إضافة مستخدم جديد
                            </button>
                        </div>

                        <!-- Users Grid -->
                        <div class="row">
                            {% for user in users %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="user-card">
                                    <div class="user-header">
                                        <div class="user-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="user-info">
                                            <h5>{{ user.username }}</h5>
                                            {% if user.is_super_admin %}
                                                <span class="badge bg-danger">مدير عام</span>
                                            {% else %}
                                                <span class="badge bg-primary">مدير</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="user-permissions">
                                        <h6>الصلاحيات:</h6>
                                        <div class="permissions-list">
                                            {% set permissions = user.get_permissions() %}
                                            {% for page, has_permission in permissions.items() %}
                                                {% if has_permission %}
                                                    <span class="permission-badge active">
                                                        <i class="fas fa-check"></i>
                                                        {{ get_permission_arabic(page) }}
                                                    </span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    
                                    <div class="user-actions">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="editUser({{ user.id }}, '{{ user.username }}', {{ user.get_permissions()|tojson }}, {{ user.is_super_admin|lower }})">
                                            <i class="fas fa-edit me-1"></i>
                                            تعديل
                                        </button>
                                        {% if not user.is_super_admin or users|selectattr('is_super_admin')|list|length > 1 %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')">
                                            <i class="fas fa-trash me-1"></i>
                                            حذف
                                        </button>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="user-meta">
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>
                                            انضم في {{ user.created_at.strftime('%Y-%m-%d') }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include all modals from the original pages -->
{% include 'modals/edit_shipment_type_modal.html' %}
{% include 'modals/add_document_type_modal.html' %}
{% include 'modals/edit_document_type_modal.html' %}
{% include 'modals/add_user_modal.html' %}
{% include 'modals/edit_user_modal.html' %}

<style>
/* Settings page specific styles */
.settings-tabs .nav-pills .nav-link {
    background: transparent;
    border: 2px solid #e9ecef;
    color: #6c757d;
    font-weight: 500;
    padding: 12px 20px;
    margin: 0 5px;
    border-radius: 10px;
    transition: all 0.3s ease;
}

.settings-tabs .nav-pills .nav-link:hover {
    background: #f8f9fa;
    border-color: #6f42c1;
    color: #6f42c1;
}

.settings-tabs .nav-pills .nav-link.active {
    background: linear-gradient(135deg, #6f42c1 0%, #512da8 100%);
    border-color: #6f42c1;
    color: white;
}

.settings-section {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.section-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f8f9fa;
}

.section-header h3 {
    color: #2d3748;
    margin-bottom: 10px;
    font-weight: 600;
}

.section-title {
    color: #4a5568;
    font-weight: 600;
    margin-bottom: 20px;
}

.types-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    max-width: 95%;
}

.table-header {
    background: #ffffff !important;
    color: #000000;
    border-bottom: 2px solid #e9ecef;
}

.table-header th {
    font-weight: 600;
    padding: 10px 12px;
    border: none;
    color: #000000 !important;
    background: #ffffff !important;
    font-size: 0.9rem;
}

.pricing-section {
    margin-bottom: 30px;
}

.pricing-section .section-header h3 {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 10px;
    background: linear-gradient(135deg, #b19cd9 0%, #9575cd 100%);
    padding: 12px 20px;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1rem;
}

.pricing-card {
    background: #ffffff;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
    transition: transform 0.2s ease;
    color: #000000;
    max-width: 300px;
    margin: 0 auto;
}

.pricing-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.pricing-header h5 {
    color: #000000;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 1rem;
}

.current-price {
    background: linear-gradient(135deg, #6f42c1 0%, #512da8 100%);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9em;
}

.stats-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 20px;
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.stats-content h3 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
    color: #2d3748;
}

.stats-content p {
    margin: 0;
    color: #6c757d;
    font-weight: 500;
}

.user-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    border: 1px solid #e9ecef;
    transition: transform 0.2s ease;
}

.user-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.user-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.user-avatar {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #6f42c1 0%, #512da8 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.user-info h5 {
    margin: 0;
    color: #2d3748;
    font-weight: 600;
}

.user-permissions h6 {
    color: #4a5568;
    font-weight: 600;
    margin-bottom: 10px;
}

.permissions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
}

.permission-badge {
    background: #e2e8f0;
    color: #4a5568;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.85em;
    font-weight: 500;
}

.permission-badge.active {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
}

.user-actions {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.user-meta {
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.price-text {
    font-weight: 600;
    color: #2d3748;
    font-size: 1.1em;
}

.types-table {
    background: #ffffff !important;
}

.types-table thead,
.types-table tbody,
.types-table tr,
.types-table td,
.types-table th {
    background: #ffffff !important;
}

.types-table tbody tr {
    background: #ffffff !important;
    color: #000000 !important;
}

.types-table tbody tr:nth-child(even) {
    background: #f8f9fa !important;
}

.types-table tbody tr:hover {
    background: #e3f2fd !important;
}

.types-table tbody td {
    color: #000000 !important;
    border-color: #e9ecef;
    background: #ffffff !important;
    padding: 8px 12px;
    font-size: 0.85rem;
    vertical-align: middle;
}

.types-table thead th {
    background: #ffffff !important;
    color: #000000 !important;
    border-bottom: 2px solid #e9ecef;
}

.pricing-section .pricing-card .form-control {
    background: #ffffff;
    color: #000000;
    border-color: #e9ecef;
    font-size: 0.9rem;
    padding: 8px 10px;
}

.pricing-section .pricing-card .form-control:focus {
    background: #ffffff;
    color: #000000;
}

/* Ensure all pricing table elements have white background */
.pricing-section .table,
.pricing-section .table thead,
.pricing-section .table tbody,
.pricing-section .table tr,
.pricing-section .table td,
.pricing-section .table th {
    background: #ffffff !important;
    color: #000000 !important;
}

.pricing-section .table thead th {
    background: #ffffff !important;
    color: #000000 !important;
    border-bottom: 2px solid #e9ecef;
    padding: 8px 10px;
    font-size: 0.85rem;
}

.pricing-section .table tbody td {
    background: #ffffff !important;
    color: #000000 !important;
    padding: 6px 10px;
    font-size: 0.8rem;
}

/* Compact table styling */
.types-table {
    background: #ffffff !important;
    font-size: 0.85rem;
}

.types-table .btn-sm {
    padding: 4px 8px;
    font-size: 0.75rem;
}

.badge {
    font-size: 0.7rem;
    padding: 4px 8px;
}

/* Theme Customization Styles */
.theme-controls-card, .theme-preview-card {
    background: #ffffff;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    margin-bottom: 20px;
}

.theme-mode-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.theme-btn {
    flex: 1;
    padding: 15px 10px;
    border: 2px solid #e9ecef;
    background: #ffffff;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    color: #2d3748;
}

.theme-btn:hover {
    border-color: #6f42c1;
    background: #f8f9fa;
}

.theme-btn.active {
    border-color: #6f42c1;
    background: linear-gradient(135deg, #6f42c1 0%, #512da8 100%);
    color: white;
}

.theme-btn i {
    display: block;
    font-size: 1.5rem;
    margin-bottom: 8px;
}

.color-input-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.color-input-group input[type="color"] {
    width: 50px;
    height: 40px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.color-input-group input[type="text"] {
    flex: 1;
    font-family: monospace;
    font-size: 0.9rem;
}

.preview-container {
    display: flex;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    height: 300px;
}

.preview-sidebar {
    width: 200px;
    background: #2d3748;
    color: white;
    padding: 15px;
}

.preview-sidebar-header h6 {
    color: white;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #4a5568;
}

.preview-nav {
    list-style: none;
    padding: 0;
    margin: 0;
}

.preview-nav li {
    padding: 8px 0;
    color: #cbd5e0;
    font-size: 0.9rem;
}

.preview-nav li i {
    margin-right: 8px;
    width: 16px;
}

.preview-content {
    flex: 1;
    padding: 15px;
    background: #f8f9fa;
}

.preview-table-container {
    background: white;
    border-radius: 5px;
    padding: 15px;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
}

.preview-table th,
.preview-table td {
    padding: 8px 12px;
    text-align: right;
    border-bottom: 1px solid #e9ecef;
}

.preview-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2d3748;
}

.preview-table td {
    color: #2d3748;
}

.theme-actions {
    border-top: 1px solid #e9ecef;
    padding-top: 20px;
}

/* Dynamic Theme Styles */
.dynamic-theme-styles {
    transition: all 0.3s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .settings-tabs .nav-pills .nav-link {
        margin: 5px 0;
        text-align: center;
    }
    
    .settings-section {
        padding: 20px;
    }
    
    .stats-card {
        text-align: center;
        flex-direction: column;
        gap: 15px;
    }
    
    .user-header {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
// User Management Functions
function deleteUser(userId, username) {
    if (confirm(`هل أنت متأكد من حذف المستخدم "${username}"؟\nلا يمكن التراجع عن هذا الإجراء.`)) {
        fetch(`/delete_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', data.message);
                // Remove user card from DOM
                const userCard = document.querySelector(`[onclick*="deleteUser(${userId}"]`).closest('.col-md-6');
                userCard.style.transition = 'all 0.3s ease';
                userCard.style.opacity = '0';
                userCard.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    userCard.remove();
                    // Check if no users left
                    const userGrid = document.querySelector('.row');
                    if (userGrid.children.length === 0) {
                        userGrid.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">لا يوجد مستخدمون</p></div>';
                    }
                }, 300);
            } else {
                showNotification('error', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', 'حدث خطأ أثناء حذف المستخدم');
        });
    }
}



function showNotification(type, message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <strong>${type === 'success' ? 'نجح' : 'خطأ'}:</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to body
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Theme Management Variables
let currentTheme = {
    mode: 'light',
    tableBackground: '#ffffff',
    tableHeader: '#f8f9fa',
    tableText: '#000000',
    sidebarBackground: '#2d3748'
};

// Load saved theme on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedTheme();
});

// Theme Management Functions
function selectThemeMode(mode) {
    // Update active button
    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-theme="${mode}"]`).classList.add('active');
    
    currentTheme.mode = mode;
    
    // Show/hide custom color pickers
    const customPickers = document.getElementById('customColorPickers');
    if (mode === 'custom') {
        customPickers.style.display = 'block';
    } else {
        customPickers.style.display = 'none';
        applyPresetTheme(mode);
    }
    
    updateTheme();
}

function applyPresetTheme(mode) {
    if (mode === 'light') {
        currentTheme = {
            mode: 'light',
            tableBackground: '#ffffff',
            tableHeader: '#f8f9fa',
            tableText: '#000000',
            sidebarBackground: '#2d3748'
        };
    } else if (mode === 'dark') {
        currentTheme = {
            mode: 'dark',
            tableBackground: '#1a202c',
            tableHeader: '#2d3748',
            tableText: '#ffffff',
            sidebarBackground: '#0f1419'
        };
    }
    
    // Update color pickers
    updateColorInputs();
}

function updateColorInputs() {
    document.getElementById('tableBackground').value = currentTheme.tableBackground;
    document.getElementById('tableBackgroundText').value = currentTheme.tableBackground;
    document.getElementById('tableHeader').value = currentTheme.tableHeader;
    document.getElementById('tableHeaderText').value = currentTheme.tableHeader;
    document.getElementById('tableText').value = currentTheme.tableText;
    document.getElementById('tableTextText').value = currentTheme.tableText;
    document.getElementById('sidebarBackground').value = currentTheme.sidebarBackground;
    document.getElementById('sidebarBackgroundText').value = currentTheme.sidebarBackground;
}

function updateColorFromText(colorPickerId, value) {
    document.getElementById(colorPickerId).value = value;
    updateTheme();
}

function updateTheme() {
    // Update current theme object
    currentTheme.tableBackground = document.getElementById('tableBackground').value;
    currentTheme.tableHeader = document.getElementById('tableHeader').value;
    currentTheme.tableText = document.getElementById('tableText').value;
    currentTheme.sidebarBackground = document.getElementById('sidebarBackground').value;
    
    // Update text inputs
    document.getElementById('tableBackgroundText').value = currentTheme.tableBackground;
    document.getElementById('tableHeaderText').value = currentTheme.tableHeader;
    document.getElementById('tableTextText').value = currentTheme.tableText;
    document.getElementById('sidebarBackgroundText').value = currentTheme.sidebarBackground;
    
    // Apply to preview
    updatePreview();
    
    // Apply to actual page (if not in preview mode)
    if (document.getElementById('applyLive').checked) {
        applyThemeToPage();
    }
}

function updatePreview() {
    const previewSidebar = document.getElementById('previewSidebar');
    const previewTable = document.getElementById('previewTable');
    const previewTableHeader = document.getElementById('previewTableHeader');
    const previewTableBody = document.getElementById('previewTableBody');
    
    // Update preview sidebar
    previewSidebar.style.backgroundColor = currentTheme.sidebarBackground;
    
    // Update preview table
    previewTable.style.backgroundColor = currentTheme.tableBackground;
    previewTableHeader.style.backgroundColor = currentTheme.tableHeader;
    previewTableHeader.style.color = currentTheme.tableText;
    previewTableBody.style.backgroundColor = currentTheme.tableBackground;
    previewTableBody.style.color = currentTheme.tableText;
    
    // Update table cells
    const cells = previewTableBody.querySelectorAll('td');
    cells.forEach(cell => {
        cell.style.color = currentTheme.tableText;
    });
}

function applyThemeToPage() {
    // Create or update dynamic style element
    let styleElement = document.getElementById('dynamicThemeStyles');
    if (!styleElement) {
        styleElement = document.createElement('style');
        styleElement.id = 'dynamicThemeStyles';
        document.head.appendChild(styleElement);
    }
    
    const css = `
        .sidebar { background-color: ${currentTheme.sidebarBackground} !important; }
        .types-table, .shipments-table { background-color: ${currentTheme.tableBackground} !important; }
        .types-table thead, .shipments-table thead { background-color: ${currentTheme.tableHeader} !important; }
        .types-table th, .types-table td, .shipments-table th, .shipments-table td { 
            color: ${currentTheme.tableText} !important; 
            background-color: ${currentTheme.tableBackground} !important;
        }
        .table-header { background-color: ${currentTheme.tableHeader} !important; }
        .table-header th { color: ${currentTheme.tableText} !important; }
    `;
    
    styleElement.textContent = css;
}

function saveTheme() {
    // Save to localStorage
    localStorage.setItem('dashboardTheme', JSON.stringify(currentTheme));
    
    // Apply to page
    applyThemeToPage();
    
    // Show success message
    showThemeMessage('تم حفظ المظهر بنجاح!', 'success');
}

function loadSavedTheme() {
    const saved = localStorage.getItem('dashboardTheme');
    if (saved) {
        currentTheme = JSON.parse(saved);
        
        // Update UI
        selectThemeMode(currentTheme.mode);
        updateColorInputs();
        updatePreview();
        applyThemeToPage();
    }
}

function resetTheme() {
    // Reset to light theme
    currentTheme = {
        mode: 'light',
        tableBackground: '#ffffff',
        tableHeader: '#f8f9fa',
        tableText: '#000000',
        sidebarBackground: '#2d3748'
    };
    
    selectThemeMode('light');
    updateColorInputs();
    updatePreview();
    
    // Remove dynamic styles
    const styleElement = document.getElementById('dynamicThemeStyles');
    if (styleElement) {
        styleElement.remove();
    }
    
    showThemeMessage('تم استعادة المظهر الافتراضي!', 'info');
}

function exportTheme() {
    const themeData = JSON.stringify(currentTheme, null, 2);
    const blob = new Blob([themeData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dashboard-theme.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showThemeMessage('تم تصدير المظهر بنجاح!', 'success');
}

function showThemeMessage(message, type) {
    // Create a temporary message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    messageDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    messageDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(messageDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 3000);
}

// JavaScript functions for managing types and users
function editShipmentType(id, nameAr, nameEn, price, isActive) {
    document.getElementById('editShipmentTypeId').value = id;
    document.getElementById('editShipmentNameAr').value = nameAr;
    document.getElementById('editShipmentNameEn').value = nameEn;
    document.getElementById('editShipmentPrice').value = price;
    document.getElementById('editShipmentActive').checked = isActive;
    
    const modal = new bootstrap.Modal(document.getElementById('editShipmentTypeModal'));
    modal.show();
}

function editDocumentType(id, nameAr, nameEn, price, isActive) {
    document.getElementById('editDocumentTypeId').value = id;
    document.getElementById('editDocumentNameAr').value = nameAr;
    document.getElementById('editDocumentNameEn').value = nameEn;
    document.getElementById('editDocumentPrice').value = price;
    document.getElementById('editDocumentActive').checked = isActive;
    
    const modal = new bootstrap.Modal(document.getElementById('editDocumentTypeModal'));
    modal.show();
}



function editUser(id, username, permissions, isSuperAdmin) {
    // Fill edit form
    document.getElementById('editUserId').value = id;
    document.getElementById('editUsername').value = username;
    document.getElementById('editPassword').value = '';
    document.getElementById('editConfirmPassword').value = '';
    
    // Set super admin checkbox
    const superAdminCheckbox = document.getElementById('editIsSuperAdmin');
    if (superAdminCheckbox) {
        superAdminCheckbox.checked = isSuperAdmin;
    }
    
    // Set permissions checkboxes - direct mapping
    const permissionCheckboxes = document.querySelectorAll('#editUserModal input[name="permissions"]');
    permissionCheckboxes.forEach(checkbox => {
        const permissionKey = checkbox.value; // home, shipments, etc. (already lowercase in HTML)
        checkbox.checked = permissions[permissionKey] || false;
    });
    
    // Update form action
    document.getElementById('editUserForm').action = `/edit_user/${id}`;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

// Update price per kg display in real-time
function updatePricePerKgDisplay(value) {
    const displayElement = document.getElementById('currentPriceDisplay');
    if (displayElement) {
        // Format to 3 decimal places
        const formattedPrice = parseFloat(value || 0).toFixed(3);
        displayElement.textContent = `${formattedPrice} د.ك`;
        
        // Add animation effect
        displayElement.style.transform = 'scale(1.05)';
        displayElement.style.transition = 'all 0.2s ease';
        setTimeout(() => {
            displayElement.style.transform = 'scale(1)';
        }, 200);
    }
    
    // Update price per kg in Add Shipment page if it's open
    if (window.parent && window.parent.refreshPricePerKg) {
        window.parent.refreshPricePerKg();
    }
    
    // If Add Shipment page is in same window, update it directly
    if (window.refreshPricePerKg) {
        window.refreshPricePerKg();
    }
}

// Update packaging price display in real-time
function updatePackagingPriceDisplay(value) {
    const displayElement = document.getElementById('currentPackagingPriceDisplay');
    if (displayElement) {
        // Format to 3 decimal places
        const formattedPrice = parseFloat(value || 0).toFixed(3);
        displayElement.textContent = `${formattedPrice} د.ك`;
        
        // Add animation effect
        displayElement.style.transform = 'scale(1.05)';
        displayElement.style.transition = 'all 0.2s ease';
        setTimeout(() => {
            displayElement.style.transform = 'scale(1)';
        }, 200);
    }
}

// Initialize Bootstrap tabs
document.addEventListener('DOMContentLoaded', function() {
    const triggerTabList = [].slice.call(document.querySelectorAll('#settingsTab button'));
    triggerTabList.forEach(function (triggerEl) {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            tabTrigger.show();
        });
    });
    
    // Initialize price displays
    const priceInput = document.getElementById('pricePerKgInput');
    if (priceInput) {
        updatePricePerKgDisplay(priceInput.value);
    }
    
    const packagingInput = document.getElementById('packagingPriceInput');
    if (packagingInput) {
        updatePackagingPriceDisplay(packagingInput.value);
    }
});
</script>

<!-- Add Procedure Type Modal -->
<div class="modal fade" id="addProcedureTypeModal" tabindex="-1" aria-labelledby="addProcedureTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProcedureTypeModalLabel">
                    <i class="fas fa-plus me-2"></i>
                    إضافة إجراء جديد
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form method="POST" action="{{ url_for('add_document_type') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="procedureNameAr" class="form-label">اسم الإجراء بالعربية *</label>
                        <input type="text" class="form-control" id="procedureNameAr" name="name_ar" placeholder="أدخل اسم الإجراء بالعربية" required>
                    </div>
                    <div class="mb-3">
                        <label for="procedureNameEn" class="form-label">اسم الإجراء بالإنجليزية</label>
                        <input type="text" class="form-control" id="procedureNameEn" name="name_en" placeholder="Enter procedure name in English">
                    </div>
                    <div class="mb-3">
                        <label for="procedurePrice" class="form-label">السعر (د.ك) *</label>
                        <input type="text" pattern="\d+(\.\d{1,3})?" inputmode="decimal" class="form-control" id="procedurePrice" name="price" placeholder="0.000" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="procedureActive" name="is_active" checked>
                        <label class="form-check-label" for="procedureActive">نشط</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        حفظ الإجراء
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Procedure Type Modal -->
<div class="modal fade" id="editProcedureTypeModal" tabindex="-1" aria-labelledby="editProcedureTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProcedureTypeModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    تعديل الإجراء
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <form method="POST" action="{{ url_for('update_document_type') }}">
                <input type="hidden" id="editProcedureTypeId" name="type_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editProcedureNameAr" class="form-label">اسم الإجراء بالعربية *</label>
                        <input type="text" class="form-control" id="editProcedureNameAr" name="name_ar" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProcedureNameEn" class="form-label">اسم الإجراء بالإنجليزية</label>
                        <input type="text" class="form-control" id="editProcedureNameEn" name="name_en">
                    </div>
                    <div class="mb-3">
                        <label for="editProcedurePrice" class="form-label">السعر (د.ك) *</label>
                        <input type="text" pattern="\d+(\.\d{1,3})?" inputmode="decimal" class="form-control" id="editProcedurePrice" name="price" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editProcedureActive" name="is_active">
                        <label class="form-check-label" for="editProcedureActive">نشط</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        حفظ التغييرات
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}