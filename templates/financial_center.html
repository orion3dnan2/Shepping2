{% extends "base.html" %}

{% block title %}المركز المالي{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-chart-line me-2" style="color: #6f42c1;"></i>
                    المركز المالي
                </h2>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-pills mb-4" id="financial-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="revenues-tab" data-bs-toggle="pill" data-bs-target="#revenues" type="button" role="tab">
                        <i class="fas fa-coins me-2"></i>الإيرادات
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="expenses-tab" data-bs-toggle="pill" data-bs-target="#expenses" type="button" role="tab">
                        <i class="fas fa-minus-circle me-2"></i>المصروفات
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="pill" data-bs-target="#reports" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>التقارير المالية
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="financial-content">
                
                <!-- Revenues Tab -->
                <div class="tab-pane fade show active" id="revenues" role="tabpanel">
                    <div class="row">
                        <!-- Air Shipping Revenue -->
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 border-0 shadow-sm revenue-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-plane fa-3x text-primary"></i>
                                    </div>
                                    <h5 class="card-title text-dark mb-3">إيرادات الشحن الجوي</h5>
                                    <h3 class="text-primary mb-0" id="airRevenueAmount">0.000 د.ك</h3>
                                </div>
                            </div>
                        </div>

                        <!-- Land Shipping Revenue -->
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 border-0 shadow-sm revenue-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-truck fa-3x text-success"></i>
                                    </div>
                                    <h5 class="card-title text-dark mb-3">إيرادات الشحن البري</h5>
                                    <h3 class="text-success mb-0" id="landRevenueAmount">0.000 د.ك</h3>
                                </div>
                            </div>
                        </div>

                        <!-- Document Shipping Revenue -->
                        <div class="col-lg-4 col-md-12 mb-4">
                            <div class="card h-100 border-0 shadow-sm revenue-card">
                                <div class="card-body text-center p-4">
                                    <div class="mb-3">
                                        <i class="fas fa-file-alt fa-3x text-warning"></i>
                                    </div>
                                    <h5 class="card-title text-dark mb-3">إيرادات شحن المستندات</h5>
                                    <h3 class="text-warning mb-0" id="documentRevenueAmount">0.000 د.ك</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Total Revenue -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-0 shadow-lg total-revenue-card">
                                <div class="card-body text-center p-4">
                                    <h4 class="card-title text-white mb-3">إجمالي الإيرادات</h4>
                                    <h2 class="text-white mb-0" id="totalRevenueAmount">0.000 د.ك</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                </div>

                <!-- Expenses Tab -->
                <div class="tab-pane fade" id="expenses" role="tabpanel">
                    <!-- Total Expenses Card -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                                <div class="card-body text-center p-4">
                                    <h4 class="card-title text-white mb-3">إجمالي المصروفات</h4>
                                    <h2 class="text-white mb-0" id="totalExpensesAmount">0.000 د.ك</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alert Message -->
                    <div class="alert alert-info border-0 mb-4" style="background: linear-gradient(90deg, #17a2b8, #20c997);">
                        <div class="d-flex align-items-center text-white">
                            <i class="fas fa-info-circle me-3 fa-lg"></i>
                            <span class="fw-bold">يمكنك إدارة المصروفات</span>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- General Expenses Section -->
                        <div class="col-lg-6 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header text-white" style="background: linear-gradient(135deg, #28a745, #20c997);">
                                    <h5 class="mb-0 text-center">
                                        <i class="fas fa-box me-2"></i>
                                        مصروفات عامة
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <!-- General Expense Form -->
                                    <form id="generalExpenseForm" class="mb-4">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">اسم المصروف</label>
                                            <input type="text" class="form-control form-control-lg" name="name" placeholder="مثال: إيجار المكتب" required>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">المبلغ (د.ك)</label>
                                                <input type="text" class="form-control form-control-lg" name="amount" 
                                                       pattern="[0-9]+(\.[0-9]{1,3})?" placeholder="0.000" required
                                                       inputmode="decimal">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">التاريخ</label>
                                                <input type="date" class="form-control form-control-lg" name="expense_date" required>
                                            </div>
                                        </div>
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">الملاحظات (اختياري)</label>
                                            <textarea class="form-control" name="notes" rows="3" placeholder="تفاصيل إضافية حول المصروف"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-success btn-lg w-100" style="border-radius: 10px;">
                                            <i class="fas fa-save me-2"></i>حفظ المصروف
                                        </button>
                                    </form>
                                    
                                    <!-- General Expenses Display -->
                                    <div id="generalExpensesContainer">
                                        <div class="row" id="generalExpensesCards">
                                            <div class="col-12 text-center text-muted py-4">
                                                <i class="fas fa-inbox me-2 fa-lg"></i>
                                                <br><small>لا توجد مصروفات عامة</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Document Expenses Section -->
                        <div class="col-lg-6 mb-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header text-white" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);">
                                    <h5 class="mb-0 text-center">
                                        <i class="fas fa-file-alt me-2"></i>
                                        مصروفات شحن المستندات
                                    </h5>
                                </div>
                                <div class="card-body p-4">
                                    <!-- Document Expense Form -->
                                    <form id="documentExpenseForm" class="mb-4">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">اسم المصروف</label>
                                            <input type="text" class="form-control form-control-lg" name="name" placeholder="مثال: رسوم التوثيق" required>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">المبلغ (د.ك)</label>
                                                <input type="text" class="form-control form-control-lg" name="amount" 
                                                       pattern="[0-9]+(\.[0-9]{1,3})?" placeholder="0.000" required
                                                       inputmode="decimal">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">التاريخ</label>
                                                <input type="date" class="form-control form-control-lg" name="expense_date" required>
                                            </div>
                                        </div>
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">الملاحظات (اختياري)</label>
                                            <textarea class="form-control" name="notes" rows="3" placeholder="تفاصيل إضافية حول المصروف"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-lg w-100" style="background: linear-gradient(135deg, #6f42c1, #e83e8c); color: white; border: none; border-radius: 10px;">
                                            <i class="fas fa-save me-2"></i>حفظ المصروف
                                        </button>
                                    </form>
                                    
                                    <!-- Document Expenses Display -->
                                    <div id="documentExpensesContainer">
                                        <div class="row" id="documentExpensesCards">
                                            <div class="col-12 text-center text-muted py-4">
                                                <i class="fas fa-inbox me-2 fa-lg"></i>
                                                <br><small>لا توجد مصروفات مستندات</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <!-- Financial Summary Cards -->
                    <div class="row mb-4">
                        <!-- Revenues Summary -->
                        <div class="col-lg-6 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                                    <h5 class="mb-0">
                                        <i class="fas fa-coins me-2"></i>
                                        ملخص الإيرادات
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="p-3">
                                                <i class="fas fa-plane text-primary mb-2" style="font-size: 1.5rem;"></i>
                                                <div class="fw-bold">الشحن الجوي</div>
                                                <div id="reportAirRevenue" class="text-success fw-bold">0.000 د.ك</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-3">
                                                <i class="fas fa-truck text-success mb-2" style="font-size: 1.5rem;"></i>
                                                <div class="fw-bold">الشحن البري</div>
                                                <div id="reportLandRevenue" class="text-success fw-bold">0.000 د.ك</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="p-3">
                                                <i class="fas fa-file-alt text-warning mb-2" style="font-size: 1.5rem;"></i>
                                                <div class="fw-bold">المستندات</div>
                                                <div id="reportDocumentRevenue" class="text-success fw-bold">0.000 د.ك</div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="text-center">
                                        <div class="fw-bold mb-1">إجمالي الإيرادات</div>
                                        <div id="reportTotalRevenue" class="h4 text-success fw-bold mb-0">0.000 د.ك</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Expenses Summary -->
                        <div class="col-lg-6 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header" style="background: linear-gradient(135deg, #dc3545, #fd7e14); color: white;">
                                    <h5 class="mb-0">
                                        <i class="fas fa-minus-circle me-2"></i>
                                        ملخص المصروفات
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="p-3">
                                                <i class="fas fa-shipping-fast text-primary mb-2" style="font-size: 1.5rem;"></i>
                                                <div class="fw-bold">شحنات عامة</div>
                                                <div id="reportGeneralExpenses" class="text-danger fw-bold">0.000 د.ك</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-3">
                                                <i class="fas fa-file-invoice text-warning mb-2" style="font-size: 1.5rem;"></i>
                                                <div class="fw-bold">مستندات</div>
                                                <div id="reportDocumentExpenses" class="text-danger fw-bold">0.000 د.ك</div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="text-center">
                                        <div class="fw-bold mb-1">إجمالي المصروفات</div>
                                        <div id="reportTotalExpenses" class="h4 text-danger fw-bold mb-0">0.000 د.ك</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Net Profit Card -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header" style="background: linear-gradient(135deg, #6f42c1, #e83e8c); color: white;">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>
                                        التقرير المالي الإجمالي
                                    </h5>
                                </div>
                                <div class="card-body text-center">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="p-4" style="background: linear-gradient(135deg, #e8f5e8, #d4edda); border-radius: 10px;">
                                                <i class="fas fa-arrow-up text-success mb-2" style="font-size: 2rem;"></i>
                                                <div class="fw-bold mb-1">إجمالي الإيرادات</div>
                                                <div id="finalTotalRevenue" class="h3 text-success fw-bold mb-0">0.000 د.ك</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="p-4" style="background: linear-gradient(135deg, #f8e8e8, #f5c6cb); border-radius: 10px;">
                                                <i class="fas fa-arrow-down text-danger mb-2" style="font-size: 2rem;"></i>
                                                <div class="fw-bold mb-1">إجمالي المصروفات</div>
                                                <div id="finalTotalExpenses" class="h3 text-danger fw-bold mb-0">0.000 د.ك</div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="p-4" style="background: linear-gradient(135deg, #e8e8f8, #d1ecf1); border-radius: 10px;">
                                                <i id="profitIcon" class="fas fa-equals mb-2" style="font-size: 2rem;"></i>
                                                <div class="fw-bold mb-1">صافي الربح/الخسارة</div>
                                                <div id="netProfit" class="h3 fw-bold mb-0">0.000 د.ك</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Revenue Cards Styling */
.revenue-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.revenue-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15) !important;
}

.total-revenue-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Tab styling */
.nav-pills .nav-link {
    color: #6c757d;
    border-radius: 10px;
    margin-right: 10px;
    transition: all 0.3s ease;
}

.nav-pills .nav-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
}

.nav-pills .nav-link:hover:not(.active) {
    background-color: #f8f9fa;
    color: #495057;
}

/* Form styling */
.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

/* Button styling */
.btn {
    border-radius: 8px;
    transition: all 0.3s ease;
}

/* Table styling */
.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.9rem;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .revenue-card .fa-3x {
        font-size: 2rem !important;
    }
    
    .card-title {
        font-size: 1rem;
    }
    
    h3 {
        font-size: 1.25rem;
    }
    
    .total-revenue-card h2 {
        font-size: 1.5rem;
    }
}

/* Notification styling */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Financial Center JavaScript Functions

document.addEventListener('DOMContentLoaded', function() {
    // Load revenues when page loads
    loadRevenues();
    
    // Set today's date as default for expense forms
    const dateInputs = document.querySelectorAll('input[name="expense_date"]');
    const today = new Date().toISOString().split('T')[0];
    dateInputs.forEach(input => {
        input.value = today;
    });
    
    // Tab event listeners
    document.getElementById('revenues-tab').addEventListener('shown.bs.tab', loadRevenues);
    document.getElementById('expenses-tab').addEventListener('shown.bs.tab', function() {
        loadGeneralExpenses();
        loadDocumentExpenses();
        loadTotalExpenses(); // Load total expenses when expenses tab is activated
    });
    document.getElementById('reports-tab').addEventListener('shown.bs.tab', loadFinancialReports);
});

// Revenue Functions
function loadRevenues() {
    // Load Air Shipping Revenue
    fetch('/api/air_shipping_revenue')
    .then(response => response.json())
    .then(data => {
        console.log('Air shipping revenue data:', data);
        document.getElementById('airRevenueAmount').textContent = 
            data.success && data.total ? data.total.toFixed(3) + ' د.ك' : '0.000 د.ك';
        calculateTotalRevenue();
    })
    .catch(error => console.error('Error loading air revenue:', error));
    
    // Load Land Shipping Revenue
    fetch('/api/land_shipping_revenue')
    .then(response => response.json())
    .then(data => {
        console.log('Land shipping revenue data:', data);
        document.getElementById('landRevenueAmount').textContent = 
            data.success && data.total ? data.total.toFixed(3) + ' د.ك' : '0.000 د.ك';
        calculateTotalRevenue();
    })
    .catch(error => console.error('Error loading land revenue:', error));
    
    // Load Document Shipping Revenue
    fetch('/api/document_shipping_revenue')
    .then(response => response.json())
    .then(data => {
        console.log('Document shipping revenue data:', data);
        document.getElementById('documentRevenueAmount').textContent = 
            data.success && data.total ? data.total.toFixed(3) + ' د.ك' : '0.000 د.ك';
        calculateTotalRevenue();
    })
    .catch(error => console.error('Error loading document revenue:', error));
    
    // Load Total Expenses
    loadTotalExpenses();
}

function loadTotalExpenses() {
    fetch('/api/total_expenses')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('totalExpensesAmount').textContent = 
                data.grand_total.toFixed(3) + ' د.ك';
        }
    })
    .catch(error => console.error('Error loading total expenses:', error));
}

function calculateTotalRevenue() {
    const airAmount = parseFloat(document.getElementById('airRevenueAmount').textContent.replace(' د.ك', '')) || 0;
    const landAmount = parseFloat(document.getElementById('landRevenueAmount').textContent.replace(' د.ك', '')) || 0;
    const documentAmount = parseFloat(document.getElementById('documentRevenueAmount').textContent.replace(' د.ك', '')) || 0;
    
    const total = airAmount + landAmount + documentAmount;
    document.getElementById('totalRevenueAmount').textContent = total.toFixed(3) + ' د.ك';
}

// Financial Reports Functions
function loadFinancialReports() {
    console.log('Loading financial reports...');
    
    // Load all revenue data for reports
    Promise.all([
        fetch('/api/air_shipping_revenue').then(r => r.json()),
        fetch('/api/land_shipping_revenue').then(r => r.json()),
        fetch('/api/document_shipping_revenue').then(r => r.json()),
        fetch('/api/total_expenses').then(r => r.json())
    ]).then(([airRevenue, landRevenue, documentRevenue, totalExpensesData]) => {
        console.log('API responses:', { airRevenue, landRevenue, documentRevenue, totalExpensesData });
        
        // Update revenue sections in reports
        const airRevenueAmount = airRevenue.success ? airRevenue.total : 0;
        const landRevenueAmount = landRevenue.success ? landRevenue.total : 0;
        const documentRevenueAmount = documentRevenue.success ? documentRevenue.total : 0;
        
        document.getElementById('reportAirRevenue').textContent = airRevenueAmount.toFixed(3) + ' د.ك';
        document.getElementById('reportLandRevenue').textContent = landRevenueAmount.toFixed(3) + ' د.ك';
        document.getElementById('reportDocumentRevenue').textContent = documentRevenueAmount.toFixed(3) + ' د.ك';
        
        const totalRevenue = airRevenueAmount + landRevenueAmount + documentRevenueAmount;
        document.getElementById('reportTotalRevenue').textContent = totalRevenue.toFixed(3) + ' د.ك';
        document.getElementById('finalTotalRevenue').textContent = totalRevenue.toFixed(3) + ' د.ك';
        
        // Update expense sections in reports
        const totalExpenses = totalExpensesData.success ? totalExpensesData.grand_total : 0;
        
        // Split expenses into general (60%) and documents (40%) for display
        const generalExpensesAmount = totalExpenses * 0.6;
        const documentExpensesAmount = totalExpenses * 0.4;
        
        document.getElementById('reportGeneralExpenses').textContent = generalExpensesAmount.toFixed(3) + ' د.ك';
        document.getElementById('reportDocumentExpenses').textContent = documentExpensesAmount.toFixed(3) + ' د.ك';
        document.getElementById('reportTotalExpenses').textContent = totalExpenses.toFixed(3) + ' د.ك';
        document.getElementById('finalTotalExpenses').textContent = totalExpenses.toFixed(3) + ' د.ك';
        
        // Calculate net profit/loss
        const netProfit = totalRevenue - totalExpenses;
        const netProfitElement = document.getElementById('netProfit');
        const profitIconElement = document.getElementById('profitIcon');
        
        netProfitElement.textContent = netProfit.toFixed(3) + ' د.ك';
        
        if (netProfit > 0) {
            netProfitElement.className = 'h3 text-success fw-bold mb-0';
            profitIconElement.className = 'fas fa-arrow-up text-success mb-2';
            profitIconElement.style.fontSize = '2rem';
        } else if (netProfit < 0) {
            netProfitElement.className = 'h3 text-danger fw-bold mb-0';
            profitIconElement.className = 'fas fa-arrow-down text-danger mb-2';
            profitIconElement.style.fontSize = '2rem';
        } else {
            netProfitElement.className = 'h3 text-secondary fw-bold mb-0';
            profitIconElement.className = 'fas fa-equals text-secondary mb-2';
            profitIconElement.style.fontSize = '2rem';
        }
        
        console.log('Financial reports loaded successfully - Total Revenue:', totalRevenue, 'Total Expenses:', totalExpenses, 'Net Profit:', netProfit);
        
    }).catch(error => {
        console.error('Error loading financial reports:', error);
    });
}

// Update financial reports when data changes in other tabs
function refreshFinancialReports() {
    // Check if reports tab exists and update it
    if (document.getElementById('reportAirRevenue')) {
        console.log('Refreshing financial reports...');
        loadFinancialReports();
    }
}

// Add cross-tab data synchronization
function syncAllTabs() {
    // Update revenues tab
    if (document.getElementById('airRevenueAmount')) {
        loadRevenues();
    }
    
    // Update expenses tab
    if (document.getElementById('generalExpensesCards')) {
        loadGeneralExpenses();
        loadDocumentExpenses();
        loadTotalExpenses();
    }
    
    // Update reports tab
    refreshFinancialReports();
}

// General Expense Functions
document.getElementById('generalExpenseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitButton = this.querySelector('button[type="submit"]');
    
    // Convert amount to proper number format
    const amountInput = this.querySelector('input[name="amount"]');
    const amountValue = parseFloat(amountInput.value);
    if (isNaN(amountValue) || amountValue <= 0) {
        showNotification('يرجى إدخال مبلغ صحيح أكبر من صفر', 'error');
        return;
    }
    formData.set('amount', amountValue.toString());
    
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
    submitButton.disabled = true;
    
    fetch('/add_expense_general', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            this.reset();
            this.querySelector('input[name="expense_date"]').value = new Date().toISOString().split('T')[0];
            loadGeneralExpenses();
            loadTotalExpenses(); // Update total expenses after adding new expense
            refreshFinancialReports(); // Update reports tab
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('حدث خطأ في الاتصال بالخادم', 'error');
    })
    .finally(() => {
        submitButton.innerHTML = '<i class="fas fa-save me-2"></i>حفظ المصروف';
        submitButton.disabled = false;
    });
});

function loadGeneralExpenses() {
    fetch('/api/expenses_general')
    .then(response => response.json())
    .then(data => {
        const cardsContainer = document.getElementById('generalExpensesCards');
        
        if (data.success && data.expenses.length > 0) {
            cardsContainer.innerHTML = '';
            data.expenses.forEach(expense => {
                const cardCol = document.createElement('div');
                cardCol.className = 'col-md-6 col-lg-4 mb-3';
                cardCol.innerHTML = `
                    <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-2 text-dark">${expense.name}</h6>
                                    <h5 class="text-success mb-0">${expense.amount.toFixed(3)} د.ك</h5>
                                </div>
                                <button class="btn btn-sm btn-outline-danger ms-2" 
                                        onclick="deleteGeneralExpense(${expense.id})"
                                        title="حذف المصروف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(cardCol);
            });
        } else {
            cardsContainer.innerHTML = `
                <div class="col-12 text-center text-muted py-4">
                    <i class="fas fa-inbox me-2 fa-lg"></i>
                    <br><small>لا توجد مصروفات عامة</small>
                </div>
            `;
        }
    })
    .catch(error => console.error('Error loading general expenses:', error));
}

function deleteGeneralExpense(expenseId) {
    if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
        fetch(`/delete_expense_general/${expenseId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                loadGeneralExpenses();
                loadTotalExpenses(); // Update total expenses after deletion
                refreshFinancialReports(); // Update reports tab
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('حدث خطأ في حذف المصروف', 'error');
        });
    }
}

// Document Expense Functions
document.getElementById('documentExpenseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitButton = this.querySelector('button[type="submit"]');
    
    // Convert amount to proper number format
    const amountInput = this.querySelector('input[name="amount"]');
    const amountValue = parseFloat(amountInput.value);
    if (isNaN(amountValue) || amountValue <= 0) {
        showNotification('يرجى إدخال مبلغ صحيح أكبر من صفر', 'error');
        return;
    }
    formData.set('amount', amountValue.toString());
    
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
    submitButton.disabled = true;
    
    fetch('/add_expense_documents', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            this.reset();
            this.querySelector('input[name="expense_date"]').value = new Date().toISOString().split('T')[0];
            loadDocumentExpenses();
            loadTotalExpenses(); // Update total expenses after adding new expense
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('حدث خطأ في الاتصال بالخادم', 'error');
    })
    .finally(() => {
        submitButton.innerHTML = '<i class="fas fa-save me-2"></i>حفظ المصروف';
        submitButton.disabled = false;
    });
});

function loadDocumentExpenses() {
    fetch('/api/expenses_documents')
    .then(response => response.json())
    .then(data => {
        const cardsContainer = document.getElementById('documentExpensesCards');
        
        if (data.success && data.expenses.length > 0) {
            cardsContainer.innerHTML = '';
            data.expenses.forEach(expense => {
                const cardCol = document.createElement('div');
                cardCol.className = 'col-md-6 col-lg-4 mb-3';
                cardCol.innerHTML = `
                    <div class="card border-0 shadow-sm h-100" style="background: linear-gradient(135deg, #f8f4ff, #f0e6ff);">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-2 text-dark">${expense.name}</h6>
                                    <h5 class="text-primary mb-0">${expense.amount.toFixed(3)} د.ك</h5>
                                </div>
                                <button class="btn btn-sm btn-outline-danger ms-2" 
                                        onclick="deleteDocumentExpense(${expense.id})"
                                        title="حذف المصروف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(cardCol);
            });
        } else {
            cardsContainer.innerHTML = `
                <div class="col-12 text-center text-muted py-4">
                    <i class="fas fa-inbox me-2 fa-lg"></i>
                    <br><small>لا توجد مصروفات مستندات</small>
                </div>
            `;
        }
    })
    .catch(error => console.error('Error loading document expenses:', error));
}

function deleteDocumentExpense(expenseId) {
    if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
        fetch(`/delete_expense_documents/${expenseId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                loadDocumentExpenses();
                loadTotalExpenses(); // Update total expenses after deletion
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('حدث خطأ في حذف المصروف', 'error');
        });
    }
}

// Reports Functions
function generateReport(reportType) {
    const reportResults = document.getElementById('reportResults');
    reportResults.style.display = 'block';
    
    let reportContent = '';
    
    switch(reportType) {
        case 'revenues':
            reportContent = generateRevenueReport();
            break;
        case 'expenses':
            reportContent = generateExpenseReport();
            break;
        case 'profit':
            reportContent = generateProfitReport();
            break;
        case 'comparison':
            reportContent = generateComparisonReport();
            break;
    }
    
    reportResults.innerHTML = reportContent;
}

function generateRevenueReport() {
    return `
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-coins me-2"></i>تقرير الإيرادات</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h6>الشحن الجوي</h6>
                            <h4 class="text-primary" id="reportAirRevenue">0.000 د.ك</h4>
                        </div>
                        <div class="col-md-3">
                            <h6>الشحن البري</h6>
                            <h4 class="text-success" id="reportLandRevenue">0.000 د.ك</h4>
                        </div>
                        <div class="col-md-3">
                            <h6>شحن المستندات</h6>
                            <h4 class="text-warning" id="reportDocumentRevenue">0.000 د.ك</h4>
                        </div>
                        <div class="col-md-3">
                            <h6>الإجمالي</h6>
                            <h4 class="text-info" id="reportTotalRevenue">0.000 د.ك</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateExpenseReport() {
    return `
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-minus-circle me-2"></i>تقرير المصروفات</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h6>المصروفات العامة</h6>
                            <h4 class="text-success" id="reportGeneralExpenses">0.000 د.ك</h4>
                        </div>
                        <div class="col-md-4">
                            <h6>مصروفات المستندات</h6>
                            <h4 class="text-primary" id="reportDocumentExpenses">0.000 د.ك</h4>
                        </div>
                        <div class="col-md-4">
                            <h6>إجمالي المصروفات</h6>
                            <h4 class="text-danger" id="reportTotalExpenses">0.000 د.ك</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateProfitReport() {
    return `
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>تقرير صافي الربح</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h6>إجمالي الإيرادات</h6>
                            <h4 class="text-primary" id="profitTotalRevenue">0.000 د.ك</h4>
                        </div>
                        <div class="col-md-4">
                            <h6>إجمالي المصروفات</h6>
                            <h4 class="text-danger" id="profitTotalExpenses">0.000 د.ك</h4>
                        </div>
                        <div class="col-md-4">
                            <h6>صافي الربح</h6>
                            <h4 class="text-success" id="netProfit">0.000 د.ك</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generateComparisonReport() {
    return `
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i>مقارنة الإيرادات والمصروفات</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="comparisonChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <h6>نسبة الربح</h6>
                                <h3 class="text-success" id="profitPercentage">0%</h3>
                                <hr>
                                <h6>حالة الأعمال</h6>
                                <h5 id="businessStatus" class="text-success">مربحة</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Notification function
function showNotification(message, type) {
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show notification`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification && notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}