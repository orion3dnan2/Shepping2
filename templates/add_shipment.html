{% extends "base.html" %}

{% block title %}إضافة شحنة جديدة{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">إضافة شحنة جديدة</h3>
                </div>
                <div class="card-body">
                    <form id="addShipmentForm" method="POST" action="{{ url_for('add_shipment') }}">
                        
                        <!-- Direction Field -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="direction" class="form-label required-field">اتجاه الشحنة</label>
                                <select class="form-select" id="direction" name="direction" required>
                                    <option value="">اختر الاتجاه</option>
                                    <option value="kuwait_to_sudan">من الكويت إلى السودان</option>
                                    <option value="sudan_to_kuwait">من السودان إلى الكويت</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="package_type" class="form-label required-field">نوع الشحنة</label>
                                <select class="form-select" id="package_type" name="package_type" required onchange="toggleDocumentType()">
                                    <option value="">اختر نوع الشحنة</option>
                                    <option value="general">شحنة عامة</option>
                                    <option value="document">مستندات</option>
                                </select>
                            </div>
                        </div>

                        <!-- Document Type Field (Only for Documents) -->
                        <div class="document-type-field" id="document_type_field" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="document_type" class="form-label required-field">نوع المستند</label>
                                    <select class="form-select" id="document_type" name="document_type" onchange="updateDocumentPrice()">
                                        <option value="">اختر نوع المستند</option>
                                        {% for document_type in document_types %}
                                        <option value="{{ document_type.name_en }}" data-price="{{ document_type.price }}">{{ document_type.name_ar }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Sender Information -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="sender_name" class="form-label required-field">اسم المرسل</label>
                                <input type="text" class="form-control" id="sender_name" name="sender_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="sender_phone" class="form-label required-field">رقم هاتف المرسل</label>
                                <input type="tel" class="form-control" id="sender_phone" name="sender_phone" required>
                            </div>
                        </div>

                        <!-- Receiver Information -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="receiver_name" class="form-label required-field">اسم المستقبل</label>
                                <input type="text" class="form-control" id="receiver_name" name="receiver_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="receiver_phone" class="form-label required-field">رقم هاتف المستقبل</label>
                                <input type="tel" class="form-control" id="receiver_phone" name="receiver_phone" required>
                            </div>
                        </div>

                        <!-- Price Information -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="total_price" class="form-label required-field">السعر للعميل</label>
                                <input type="number" step="0.01" class="form-control" id="total_price" name="total_price" required placeholder="0.00">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="discount" class="form-label">الخصم (د.ك)</label>
                                <input type="number" step="0.01" class="form-control" id="discount" name="discount" placeholder="0.00">
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="amount_paid" class="form-label required-field">المبلغ المدفوع</label>
                                <input type="number" step="0.01" class="form-control" id="amount_paid" name="amount_paid" required placeholder="0.00">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="remaining_amount" class="form-label">المبلغ المتبقي</label>
                                <input type="number" step="0.01" class="form-control" id="remaining_amount" name="remaining_amount" placeholder="0.00" readonly>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label for="notes" class="form-label">ملاحظات إضافية</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="أي ملاحظات خاصة بالشحنة"></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>حفظ الشحنة
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleDocumentType() {
        const packageType = document.getElementById('package_type').value;
        const documentTypeField = document.getElementById('document_type_field');
        const documentTypeSelect = document.getElementById('document_type');
        
        if (packageType === 'document') {
            // Show document type field
            documentTypeField.style.display = 'block';
            documentTypeSelect.required = true;
            
            // Set required attributes for discount and remaining amount for document shipments
            const discountField = document.getElementById('discount');
            const remainingField = document.getElementById('remaining_amount');
            if (discountField) discountField.setAttribute('required', 'required');
            if (remainingField) remainingField.setAttribute('required', 'required');
            
        } else {
            // Hide document type field for non-documents
            documentTypeField.style.display = 'none';
            documentTypeSelect.value = '';
            documentTypeSelect.required = false;
            
            // Remove required attributes from discount and remaining amount for general shipments
            const discountField = document.getElementById('discount');
            const remainingField = document.getElementById('remaining_amount');
            if (discountField) discountField.removeAttribute('required');
            if (remainingField) remainingField.removeAttribute('required');
        }
    }

    function updateDocumentPrice() {
        const documentTypeSelect = document.getElementById('document_type');
        const totalPriceField = document.getElementById('total_price');
        
        if (documentTypeSelect.value) {
            const selectedOption = documentTypeSelect.options[documentTypeSelect.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            totalPriceField.value = price;
        } else {
            totalPriceField.value = '';
        }
    }

    // Calculate remaining amount
    function calculateRemaining() {
        const totalPrice = parseFloat(document.getElementById('total_price').value) || 0;
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const amountPaid = parseFloat(document.getElementById('amount_paid').value) || 0;
        
        const finalPrice = totalPrice - discount;
        const remaining = finalPrice - amountPaid;
        
        document.getElementById('remaining_amount').value = remaining.toFixed(2);
    }

    // Add event listeners
    document.getElementById('total_price').addEventListener('input', calculateRemaining);
    document.getElementById('discount').addEventListener('input', calculateRemaining);
    document.getElementById('amount_paid').addEventListener('input', calculateRemaining);
</script>
{% endblock %}